import { Directive, ElementRef, EventEmitter, Inject, Injector, Input, Optional, Output, } from '@angular/core';
import { DynamicComponentInjectorToken, } from '../component-injector/token';
import { IoFactoryService } from '../io/io-factory.service';
import { extractNgParamTypes, getCtorParamTypes } from '../util';
import * as i0 from "@angular/core";
import * as i1 from "../io/io-factory.service";
import * as i2 from "../window-ref/window-ref.service";
export function dynamicDirectiveDef(type, inputs, outputs) {
    return { type, inputs, outputs };
}
export class DynamicDirectivesDirective {
    constructor(iterableDiffers, ioFactoryService, windowRef, componentInjector) {
        this.iterableDiffers = iterableDiffers;
        this.ioFactoryService = ioFactoryService;
        this.windowRef = windowRef;
        this.componentInjector = componentInjector;
        this.ndcDynamicDirectivesCreated = new EventEmitter();
        this.dirRef = new Map();
        this.dirIo = new Map();
        this.dirsDiffer = this.iterableDiffers
            .find([])
            .create((_, def) => def.type);
    }
    get directives() {
        return (this.ndcDynamicDirectives || this.ngComponentOutletNdcDynamicDirectives);
    }
    get componentRef() {
        return this.componentInjector.componentRef;
    }
    get compInstance() {
        return this.componentRef && this.componentRef.instance;
    }
    get isCompChanged() {
        if (this.lastCompInstance !== this.compInstance) {
            this.lastCompInstance = this.compInstance;
            return true;
        }
        return false;
    }
    get hostInjector() {
        return this.componentRef.injector;
    }
    get hostVcr() {
        // NOTE: Accessing private APIs of Angular
        // eslint-disable-next-line @typescript-eslint/dot-notation
        return this.componentRef['_viewRef']['_viewContainerRef'];
    }
    get reflect() {
        return this.windowRef.nativeWindow.Reflect;
    }
    ngDoCheck() {
        if (this.maybeDestroyDirectives()) {
            return;
        }
        const dirsChanges = this.dirsDiffer.diff(this.directives);
        if (!dirsChanges) {
            return this.updateDirectives();
        }
        this.processDirChanges(dirsChanges);
    }
    ngOnDestroy() {
        this.destroyAllDirectives();
    }
    maybeDestroyDirectives() {
        if (this.isCompChanged || !this.componentRef) {
            this.dirsDiffer.diff([]);
            this.destroyAllDirectives();
        }
        return !this.componentRef;
    }
    processDirChanges(changes) {
        changes.forEachRemovedItem(({ item }) => this.destroyDirective(item));
        const createdDirs = [];
        changes.forEachAddedItem(({ item }) => createdDirs.push(this.initDirective(item)));
        if (createdDirs.length) {
            this.ndcDynamicDirectivesCreated.emit(createdDirs.filter(Boolean));
        }
    }
    updateDirectives() {
        this.directives.forEach((dir) => this.updateDirective(dir));
    }
    updateDirective(dirDef) {
        const io = this.dirIo.get(dirDef.type);
        io.update(dirDef.inputs, dirDef.outputs, false, false);
        io.maybeUpdate();
    }
    initDirective(dirDef) {
        if (this.dirRef.has(dirDef.type)) {
            return;
        }
        const instance = this.createDirective(dirDef.type);
        const dir = {
            instance,
            type: dirDef.type,
            injector: this.hostInjector,
            hostComponent: this.componentRef.instance,
            hostView: this.componentRef.hostView,
            location: this.componentRef.location,
            changeDetectorRef: this.componentRef.changeDetectorRef,
            onDestroy: this.componentRef.onDestroy,
        };
        this.initDirIO(dir, dirDef.inputs, dirDef.outputs);
        this.callInitHooks(instance);
        this.dirRef.set(dir.type, dir);
        return dir;
    }
    destroyAllDirectives() {
        this.dirRef.forEach((dir) => this.destroyDirRef(dir));
        this.dirRef.clear();
        this.dirIo.clear();
    }
    destroyDirective(dirDef) {
        this.destroyDirRef(this.dirRef.get(dirDef.type));
        this.dirRef.delete(dirDef.type);
        this.dirIo.delete(dirDef.type);
    }
    initDirIO(dir, inputs, outputs) {
        const io = this.ioFactoryService.create();
        io.init({ componentRef: this.dirToCompDef(dir) }, { trackOutputChanges: true });
        io.update(inputs, outputs, !!inputs, !!outputs);
        this.dirIo.set(dir.type, io);
    }
    dirToCompDef(dir) {
        return {
            changeDetectorRef: this.componentRef.changeDetectorRef,
            hostView: this.componentRef.hostView,
            location: this.componentRef.location,
            destroy: this.componentRef.destroy,
            onDestroy: this.componentRef.onDestroy,
            injector: this.componentRef.injector,
            instance: dir.instance,
            componentType: dir.type,
        };
    }
    destroyDirRef(dir) {
        const io = this.dirIo.get(dir.type);
        io.ngOnDestroy();
        if ('ngOnDestroy' in dir.instance) {
            dir.instance.ngOnDestroy();
        }
    }
    createDirective(dirType) {
        const directiveInjector = Injector.create({
            providers: [
                {
                    provide: dirType,
                    useClass: dirType,
                    deps: this.resolveDirParamTypes(dirType),
                },
                { provide: ElementRef, useValue: this.componentRef.location },
            ],
            parent: this.hostInjector,
            name: `DynamicDirectiveInjector:${dirType.name}@${this.componentRef.componentType.name}`,
        });
        return directiveInjector.get(dirType);
    }
    resolveDirParamTypes(dirType) {
        return (
        // First try Angular Compiler's metadata
        extractNgParamTypes(dirType) ??
            // Then fallback to Typescript Reflect API
            getCtorParamTypes(dirType, this.reflect) ??
            // Bailout
            []);
    }
    callInitHooks(obj) {
        this.callHook(obj, 'ngOnInit');
        this.callHook(obj, 'ngDoCheck');
        this.callHook(obj, 'ngAfterContentInit');
        this.callHook(obj, 'ngAfterContentChecked');
        this.callHook(obj, 'ngAfterViewInit');
        this.callHook(obj, 'ngAfterViewChecked');
    }
    callHook(obj, hook, args = []) {
        if (obj[hook]) {
            obj[hook](...args);
        }
    }
}
/** @nocollapse */ /** @nocollapse */ DynamicDirectivesDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.0.2", ngImport: i0, type: DynamicDirectivesDirective, deps: [{ token: i0.IterableDiffers }, { token: i1.IoFactoryService }, { token: i2.WindowRefService }, { token: DynamicComponentInjectorToken, optional: true }], target: i0.ɵɵFactoryTarget.Directive });
/** @nocollapse */ /** @nocollapse */ DynamicDirectivesDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.0.2", type: DynamicDirectivesDirective, selector: "[ndcDynamicDirectives],[ngComponentOutletNdcDynamicDirectives]", inputs: { ndcDynamicDirectives: "ndcDynamicDirectives", ngComponentOutletNdcDynamicDirectives: "ngComponentOutletNdcDynamicDirectives" }, outputs: { ndcDynamicDirectivesCreated: "ndcDynamicDirectivesCreated" }, providers: [IoFactoryService], ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.0.2", ngImport: i0, type: DynamicDirectivesDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[ndcDynamicDirectives],[ngComponentOutletNdcDynamicDirectives]',
                    providers: [IoFactoryService],
                }]
        }], ctorParameters: function () { return [{ type: i0.IterableDiffers }, { type: i1.IoFactoryService }, { type: i2.WindowRefService }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [DynamicComponentInjectorToken]
                }, {
                    type: Optional
                }] }]; }, propDecorators: { ndcDynamicDirectives: [{
                type: Input
            }], ngComponentOutletNdcDynamicDirectives: [{
                type: Input
            }], ndcDynamicDirectivesCreated: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1kaXJlY3RpdmVzLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25nLWR5bmFtaWMtY29tcG9uZW50L3NyYy9saWIvZHluYW1pYy1kaXJlY3RpdmVzL2R5bmFtaWMtZGlyZWN0aXZlcy5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUdMLFNBQVMsRUFFVCxVQUFVLEVBQ1YsWUFBWSxFQUNaLE1BQU0sRUFDTixRQUFRLEVBQ1IsS0FBSyxFQUlMLFFBQVEsRUFDUixNQUFNLEdBSVAsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUVMLDZCQUE2QixHQUM5QixNQUFNLDZCQUE2QixDQUFDO0FBQ3JDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRzVELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLFNBQVMsQ0FBQzs7OztBQVNqRSxNQUFNLFVBQVUsbUJBQW1CLENBQ2pDLElBQWEsRUFDYixNQUFtQixFQUNuQixPQUFxQjtJQUVyQixPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsQ0FBQztBQUNuQyxDQUFDO0FBa0JELE1BQU0sT0FBTywwQkFBMEI7SUFxRHJDLFlBQ1UsZUFBZ0MsRUFDaEMsZ0JBQWtDLEVBQ2xDLFNBQTJCLEVBRzNCLGlCQUE0QztRQUw1QyxvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDaEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxjQUFTLEdBQVQsU0FBUyxDQUFrQjtRQUczQixzQkFBaUIsR0FBakIsaUJBQWlCLENBQTJCO1FBcER0RCxnQ0FBMkIsR0FBRyxJQUFJLFlBQVksRUFBdUIsQ0FBQztRQXdDOUQsV0FBTSxHQUFHLElBQUksR0FBRyxFQUFnQyxDQUFDO1FBQ2pELFVBQUssR0FBRyxJQUFJLEdBQUcsRUFBd0IsQ0FB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LDBCQUEwQiw0U0FGMUIsQ0FBQyxnQkFBZ0IsQ0FBQzsyRkFFbEIsMEJBQTBCO2tCQUp0QyxTQUFTO21CQUFDO29CQUNULFFBQVEsRUFBRSxnRUFBZ0U7b0JBQzFFLFNBQVMsRUFBRSxDQUFDLGdCQUFnQixDQUFDO2lCQUM5Qjs7MEJBMERJLE1BQU07MkJBQUMsNkJBQTZCOzswQkFDcEMsUUFBUTs0Q0F4RFgsb0JBQW9CO3NCQURuQixLQUFLO2dCQUdOLHFDQUFxQztzQkFEcEMsS0FBSztnQkFJTiwyQkFBMkI7c0JBRDFCLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ29tcG9uZW50UmVmLFxuICBEaXJlY3RpdmUsXG4gIERvQ2hlY2ssXG4gIEVsZW1lbnRSZWYsXG4gIEV2ZW50RW1pdHRlcixcbiAgSW5qZWN0LFxuICBJbmplY3RvcixcbiAgSW5wdXQsXG4gIEl0ZXJhYmxlQ2hhbmdlcyxcbiAgSXRlcmFibGVEaWZmZXJzLFxuICBPbkRlc3Ryb3ksXG4gIE9wdGlvbmFsLFxuICBPdXRwdXQsXG4gIFR5cGUsXG4gIFZpZXdDb250YWluZXJSZWYsXG4gIFZpZXdSZWYsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQge1xuICBEeW5hbWljQ29tcG9uZW50SW5qZWN0b3IsXG4gIER5bmFtaWNDb21wb25lbnRJbmplY3RvclRva2VuLFxufSBmcm9tICcuLi9jb21wb25lbnQtaW5qZWN0b3IvdG9rZW4nO1xuaW1wb3J0IHsgSW9GYWN0b3J5U2VydmljZSB9IGZyb20gJy4uL2lvL2lvLWZhY3Rvcnkuc2VydmljZSc7XG5pbXBvcnQgeyBJb1NlcnZpY2UgfSBmcm9tICcuLi9pby9pby5zZXJ2aWNlJztcbmltcG9ydCB7IElucHV0c1R5cGUsIE91dHB1dHNUeXBlIH0gZnJvbSAnLi4vaW8vdHlwZXMnO1xuaW1wb3J0IHsgZXh0cmFjdE5nUGFyYW1UeXBlcywgZ2V0Q3RvclBhcmFtVHlwZXMgfSBmcm9tICcuLi91dGlsJztcbmltcG9ydCB7IFdpbmRvd1JlZlNlcnZpY2UgfSBmcm9tICcuLi93aW5kb3ctcmVmL3dpbmRvdy1yZWYuc2VydmljZSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRHluYW1pY0RpcmVjdGl2ZURlZjxUPiB7XG4gIHR5cGU6IFR5cGU8VD47XG4gIGlucHV0cz86IElucHV0c1R5cGU7XG4gIG91dHB1dHM/OiBPdXRwdXRzVHlwZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGR5bmFtaWNEaXJlY3RpdmVEZWY8VD4oXG4gIHR5cGU6IFR5cGU8VD4sXG4gIGlucHV0cz86IElucHV0c1R5cGUsXG4gIG91dHB1dHM/OiBPdXRwdXRzVHlwZSxcbik6IER5bmFtaWNEaXJlY3RpdmVEZWY8VD4ge1xuICByZXR1cm4geyB0eXBlLCBpbnB1dHMsIG91dHB1dHMgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEaXJlY3RpdmVSZWY8VD4ge1xuICBpbnN0YW5jZTogVDtcbiAgdHlwZTogVHlwZTxUPjtcbiAgaW5qZWN0b3I6IEluamVjdG9yO1xuICBob3N0Q29tcG9uZW50OiBUeXBlPGFueT47XG4gIGhvc3RWaWV3OiBWaWV3UmVmO1xuICBsb2NhdGlvbjogRWxlbWVudFJlZjtcbiAgY2hhbmdlRGV0ZWN0b3JSZWY6IENoYW5nZURldGVjdG9yUmVmO1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L2Jhbi10eXBlc1xuICBvbkRlc3Ryb3k6IChjYWxsYmFjazogRnVuY3Rpb24pID0+IHZvaWQ7XG59XG5cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ1tuZGNEeW5hbWljRGlyZWN0aXZlc10sW25nQ29tcG9uZW50T3V0bGV0TmRjRHluYW1pY0RpcmVjdGl2ZXNdJyxcbiAgcHJvdmlkZXJzOiBbSW9GYWN0b3J5U2VydmljZV0sXG59KVxuZXhwb3J0IGNsYXNzIER5bmFtaWNEaXJlY3RpdmVzRGlyZWN0aXZlIGltcGxlbWVudHMgT25EZXN0cm95LCBEb0NoZWNrIHtcbiAgQElucHV0KClcbiAgbmRjRHluYW1pY0RpcmVjdGl2ZXM6IER5bmFtaWNEaXJlY3RpdmVEZWY8YW55PltdO1xuICBASW5wdXQoKVxuICBuZ0NvbXBvbmVudE91dGxldE5kY0R5bmFtaWNEaXJlY3RpdmVzOiBEeW5hbWljRGlyZWN0aXZlRGVmPGFueT5bXTtcblxuICBAT3V0cHV0KClcbiAgbmRjRHluYW1pY0RpcmVjdGl2ZXNDcmVhdGVkID0gbmV3IEV2ZW50RW1pdHRlcjxEaXJlY3RpdmVSZWY8YW55PltdPigpO1xuXG4gIHByaXZhdGUgbGFzdENvbXBJbnN0YW5jZTogYW55O1xuXG4gIHByaXZhdGUgZ2V0IGRpcmVjdGl2ZXMoKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIHRoaXMubmRjRHluYW1pY0RpcmVjdGl2ZXMgfHwgdGhpcy5uZ0NvbXBvbmVudE91dGxldE5kY0R5bmFtaWNEaXJlY3RpdmVzXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IGNvbXBvbmVudFJlZigpIHtcbiAgICByZXR1cm4gdGhpcy5jb21wb25lbnRJbmplY3Rvci5jb21wb25lbnRSZWY7XG4gIH1cblxuICBwcml2YXRlIGdldCBjb21wSW5zdGFuY2UoKSB7XG4gICAgcmV0dXJuIHRoaXMuY29tcG9uZW50UmVmICYmIHRoaXMuY29tcG9uZW50UmVmLmluc3RhbmNlO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgaXNDb21wQ2hhbmdlZCgpIHtcbiAgICBpZiAodGhpcy5sYXN0Q29tcEluc3RhbmNlICE9PSB0aGlzLmNvbXBJbnN0YW5jZSkge1xuICAgICAgdGhpcy5sYXN0Q29tcEluc3RhbmNlID0gdGhpcy5jb21wSW5zdGFuY2U7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgaG9zdEluamVjdG9yKCkge1xuICAgIHJldHVybiB0aGlzLmNvbXBvbmVudFJlZi5pbmplY3RvcjtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IGhvc3RWY3IoKTogVmlld0NvbnRhaW5lclJlZiB7XG4gICAgLy8gTk9URTogQWNjZXNzaW5nIHByaXZhdGUgQVBJcyBvZiBBbmd1bGFyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9kb3Qtbm90YXRpb25cbiAgICByZXR1cm4gdGhpcy5jb21wb25lbnRSZWZbJ192aWV3UmVmJ11bJ192aWV3Q29udGFpbmVyUmVmJ107XG4gIH1cblxuICBwcml2YXRlIGdldCByZWZsZWN0KCkge1xuICAgIHJldHVybiAodGhpcy53aW5kb3dSZWYubmF0aXZlV2luZG93IGFzIGFueSkuUmVmbGVjdDtcbiAgfVxuXG4gIHByaXZhdGUgZGlyUmVmID0gbmV3IE1hcDxUeXBlPGFueT4sIERpcmVjdGl2ZVJlZjxhbnk+PigpO1xuICBwcml2YXRlIGRpcklvID0gbmV3IE1hcDxUeXBlPGFueT4sIElvU2VydmljZT4oKTtcbiAgcHJpdmF0ZSBkaXJzRGlmZmVyID0gdGhpcy5pdGVyYWJsZURpZmZlcnNcbiAgICAuZmluZChbXSlcbiAgICAuY3JlYXRlPER5bmFtaWNEaXJlY3RpdmVEZWY8YW55Pj4oKF8sIGRlZikgPT4gZGVmLnR5cGUpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgaXRlcmFibGVEaWZmZXJzOiBJdGVyYWJsZURpZmZlcnMsXG4gICAgcHJpdmF0ZSBpb0ZhY3RvcnlTZXJ2aWNlOiBJb0ZhY3RvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgd2luZG93UmVmOiBXaW5kb3dSZWZTZXJ2aWNlLFxuICAgIEBJbmplY3QoRHluYW1pY0NvbXBvbmVudEluamVjdG9yVG9rZW4pXG4gICAgQE9wdGlvbmFsKClcbiAgICBwcml2YXRlIGNvbXBvbmVudEluamVjdG9yPzogRHluYW1pY0NvbXBvbmVudEluamVjdG9yLFxuICApIHt9XG5cbiAgbmdEb0NoZWNrKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLm1heWJlRGVzdHJveURpcmVjdGl2ZXMoKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGRpcnNDaGFuZ2VzID0gdGhpcy5kaXJzRGlmZmVyLmRpZmYodGhpcy5kaXJlY3RpdmVzKTtcblxuICAgIGlmICghZGlyc0NoYW5nZXMpIHtcbiAgICAgIHJldHVybiB0aGlzLnVwZGF0ZURpcmVjdGl2ZXMoKTtcbiAgICB9XG5cbiAgICB0aGlzLnByb2Nlc3NEaXJDaGFuZ2VzKGRpcnNDaGFuZ2VzKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuZGVzdHJveUFsbERpcmVjdGl2ZXMoKTtcbiAgfVxuXG4gIHByaXZhdGUgbWF5YmVEZXN0cm95RGlyZWN0aXZlcygpIHtcbiAgICBpZiAodGhpcy5pc0NvbXBDaGFuZ2VkIHx8ICF0aGlzLmNvbXBvbmVudFJlZikge1xuICAgICAgdGhpcy5kaXJzRGlmZmVyLmRpZmYoW10pO1xuICAgICAgdGhpcy5kZXN0cm95QWxsRGlyZWN0aXZlcygpO1xuICAgIH1cblxuICAgIHJldHVybiAhdGhpcy5jb21wb25lbnRSZWY7XG4gIH1cblxuICBwcml2YXRlIHByb2Nlc3NEaXJDaGFuZ2VzKFxuICAgIGNoYW5nZXM6IEl0ZXJhYmxlQ2hhbmdlczxEeW5hbWljRGlyZWN0aXZlRGVmPGFueT4+LFxuICApIHtcbiAgICBjaGFuZ2VzLmZvckVhY2hSZW1vdmVkSXRlbSgoeyBpdGVtIH0pID0+IHRoaXMuZGVzdHJveURpcmVjdGl2ZShpdGVtKSk7XG5cbiAgICBjb25zdCBjcmVhdGVkRGlycyA9IFtdO1xuICAgIGNoYW5nZXMuZm9yRWFjaEFkZGVkSXRlbSgoeyBpdGVtIH0pID0+XG4gICAgICBjcmVhdGVkRGlycy5wdXNoKHRoaXMuaW5pdERpcmVjdGl2ZShpdGVtKSksXG4gICAgKTtcblxuICAgIGlmIChjcmVhdGVkRGlycy5sZW5ndGgpIHtcbiAgICAgIHRoaXMubmRjRHluYW1pY0RpcmVjdGl2ZXNDcmVhdGVkLmVtaXQoY3JlYXRlZERpcnMuZmlsdGVyKEJvb2xlYW4pKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZURpcmVjdGl2ZXMoKSB7XG4gICAgdGhpcy5kaXJlY3RpdmVzLmZvckVhY2goKGRpcikgPT4gdGhpcy51cGRhdGVEaXJlY3RpdmUoZGlyKSk7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZURpcmVjdGl2ZShkaXJEZWY6IER5bmFtaWNEaXJlY3RpdmVEZWY8YW55Pikge1xuICAgIGNvbnN0IGlvID0gdGhpcy5kaXJJby5nZXQoZGlyRGVmLnR5cGUpO1xuICAgIGlvLnVwZGF0ZShkaXJEZWYuaW5wdXRzLCBkaXJEZWYub3V0cHV0cywgZmFsc2UsIGZhbHNlKTtcbiAgICBpby5tYXliZVVwZGF0ZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0RGlyZWN0aXZlKFxuICAgIGRpckRlZjogRHluYW1pY0RpcmVjdGl2ZURlZjxhbnk+LFxuICApOiBEaXJlY3RpdmVSZWY8YW55PiB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKHRoaXMuZGlyUmVmLmhhcyhkaXJEZWYudHlwZSkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBpbnN0YW5jZSA9IHRoaXMuY3JlYXRlRGlyZWN0aXZlKGRpckRlZi50eXBlKTtcbiAgICBjb25zdCBkaXIgPSB7XG4gICAgICBpbnN0YW5jZSxcbiAgICAgIHR5cGU6IGRpckRlZi50eXBlLFxuICAgICAgaW5qZWN0b3I6IHRoaXMuaG9zdEluamVjdG9yLFxuICAgICAgaG9zdENvbXBvbmVudDogdGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2UsXG4gICAgICBob3N0VmlldzogdGhpcy5jb21wb25lbnRSZWYuaG9zdFZpZXcsXG4gICAgICBsb2NhdGlvbjogdGhpcy5jb21wb25lbnRSZWYubG9jYXRpb24sXG4gICAgICBjaGFuZ2VEZXRlY3RvclJlZjogdGhpcy5jb21wb25lbnRSZWYuY2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgICBvbkRlc3Ryb3k6IHRoaXMuY29tcG9uZW50UmVmLm9uRGVzdHJveSxcbiAgICB9O1xuXG4gICAgdGhpcy5pbml0RGlySU8oZGlyLCBkaXJEZWYuaW5wdXRzLCBkaXJEZWYub3V0cHV0cyk7XG4gICAgdGhpcy5jYWxsSW5pdEhvb2tzKGluc3RhbmNlKTtcblxuICAgIHRoaXMuZGlyUmVmLnNldChkaXIudHlwZSwgZGlyKTtcblxuICAgIHJldHVybiBkaXI7XG4gIH1cblxuICBwcml2YXRlIGRlc3Ryb3lBbGxEaXJlY3RpdmVzKCkge1xuICAgIHRoaXMuZGlyUmVmLmZvckVhY2goKGRpcikgPT4gdGhpcy5kZXN0cm95RGlyUmVmKGRpcikpO1xuICAgIHRoaXMuZGlyUmVmLmNsZWFyKCk7XG4gICAgdGhpcy5kaXJJby5jbGVhcigpO1xuICB9XG5cbiAgcHJpdmF0ZSBkZXN0cm95RGlyZWN0aXZlKGRpckRlZjogRHluYW1pY0RpcmVjdGl2ZURlZjxhbnk+KSB7XG4gICAgdGhpcy5kZXN0cm95RGlyUmVmKHRoaXMuZGlyUmVmLmdldChkaXJEZWYudHlwZSkpO1xuICAgIHRoaXMuZGlyUmVmLmRlbGV0ZShkaXJEZWYudHlwZSk7XG4gICAgdGhpcy5kaXJJby5kZWxldGUoZGlyRGVmLnR5cGUpO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0RGlySU8oZGlyOiBEaXJlY3RpdmVSZWY8YW55PiwgaW5wdXRzPzogYW55LCBvdXRwdXRzPzogYW55KSB7XG4gICAgY29uc3QgaW8gPSB0aGlzLmlvRmFjdG9yeVNlcnZpY2UuY3JlYXRlKCk7XG4gICAgaW8uaW5pdChcbiAgICAgIHsgY29tcG9uZW50UmVmOiB0aGlzLmRpclRvQ29tcERlZihkaXIpIH0sXG4gICAgICB7IHRyYWNrT3V0cHV0Q2hhbmdlczogdHJ1ZSB9LFxuICAgICk7XG4gICAgaW8udXBkYXRlKGlucHV0cywgb3V0cHV0cywgISFpbnB1dHMsICEhb3V0cHV0cyk7XG4gICAgdGhpcy5kaXJJby5zZXQoZGlyLnR5cGUsIGlvKTtcbiAgfVxuXG4gIHByaXZhdGUgZGlyVG9Db21wRGVmKGRpcjogRGlyZWN0aXZlUmVmPGFueT4pOiBDb21wb25lbnRSZWY8YW55PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGNoYW5nZURldGVjdG9yUmVmOiB0aGlzLmNvbXBvbmVudFJlZi5jaGFuZ2VEZXRlY3RvclJlZixcbiAgICAgIGhvc3RWaWV3OiB0aGlzLmNvbXBvbmVudFJlZi5ob3N0VmlldyxcbiAgICAgIGxvY2F0aW9uOiB0aGlzLmNvbXBvbmVudFJlZi5sb2NhdGlvbixcbiAgICAgIGRlc3Ryb3k6IHRoaXMuY29tcG9uZW50UmVmLmRlc3Ryb3ksXG4gICAgICBvbkRlc3Ryb3k6IHRoaXMuY29tcG9uZW50UmVmLm9uRGVzdHJveSxcbiAgICAgIGluamVjdG9yOiB0aGlzLmNvbXBvbmVudFJlZi5pbmplY3RvcixcbiAgICAgIGluc3RhbmNlOiBkaXIuaW5zdGFuY2UsXG4gICAgICBjb21wb25lbnRUeXBlOiBkaXIudHlwZSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBkZXN0cm95RGlyUmVmKGRpcjogRGlyZWN0aXZlUmVmPGFueT4pIHtcbiAgICBjb25zdCBpbyA9IHRoaXMuZGlySW8uZ2V0KGRpci50eXBlKTtcbiAgICBpby5uZ09uRGVzdHJveSgpO1xuXG4gICAgaWYgKCduZ09uRGVzdHJveScgaW4gZGlyLmluc3RhbmNlKSB7XG4gICAgICBkaXIuaW5zdGFuY2UubmdPbkRlc3Ryb3koKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZURpcmVjdGl2ZTxUPihkaXJUeXBlOiBUeXBlPFQ+KTogVCB7XG4gICAgY29uc3QgZGlyZWN0aXZlSW5qZWN0b3IgPSBJbmplY3Rvci5jcmVhdGUoe1xuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBkaXJUeXBlLFxuICAgICAgICAgIHVzZUNsYXNzOiBkaXJUeXBlLFxuICAgICAgICAgIGRlcHM6IHRoaXMucmVzb2x2ZURpclBhcmFtVHlwZXMoZGlyVHlwZSksXG4gICAgICAgIH0sXG4gICAgICAgIHsgcHJvdmlkZTogRWxlbWVudFJlZiwgdXNlVmFsdWU6IHRoaXMuY29tcG9uZW50UmVmLmxvY2F0aW9uIH0sXG4gICAgICBdLFxuICAgICAgcGFyZW50OiB0aGlzLmhvc3RJbmplY3RvcixcbiAgICAgIG5hbWU6IGBEeW5hbWljRGlyZWN0aXZlSW5qZWN0b3I6JHtkaXJUeXBlLm5hbWV9QCR7dGhpcy5jb21wb25lbnRSZWYuY29tcG9uZW50VHlwZS5uYW1lfWAsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gZGlyZWN0aXZlSW5qZWN0b3IuZ2V0KGRpclR5cGUpO1xuICB9XG5cbiAgcHJpdmF0ZSByZXNvbHZlRGlyUGFyYW1UeXBlcyhkaXJUeXBlOiBUeXBlPGFueT4pOiBhbnlbXSB7XG4gICAgcmV0dXJuIChcbiAgICAgIC8vIEZpcnN0IHRyeSBBbmd1bGFyIENvbXBpbGVyJ3MgbWV0YWRhdGFcbiAgICAgIGV4dHJhY3ROZ1BhcmFtVHlwZXMoZGlyVHlwZSkgPz9cbiAgICAgIC8vIFRoZW4gZmFsbGJhY2sgdG8gVHlwZXNjcmlwdCBSZWZsZWN0IEFQSVxuICAgICAgZ2V0Q3RvclBhcmFtVHlwZXMoZGlyVHlwZSwgdGhpcy5yZWZsZWN0KSA/P1xuICAgICAgLy8gQmFpbG91dFxuICAgICAgW11cbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBjYWxsSW5pdEhvb2tzKG9iajogYW55KSB7XG4gICAgdGhpcy5jYWxsSG9vayhvYmosICduZ09uSW5pdCcpO1xuICAgIHRoaXMuY2FsbEhvb2sob2JqLCAnbmdEb0NoZWNrJyk7XG4gICAgdGhpcy5jYWxsSG9vayhvYmosICduZ0FmdGVyQ29udGVudEluaXQnKTtcbiAgICB0aGlzLmNhbGxIb29rKG9iaiwgJ25nQWZ0ZXJDb250ZW50Q2hlY2tlZCcpO1xuICAgIHRoaXMuY2FsbEhvb2sob2JqLCAnbmdBZnRlclZpZXdJbml0Jyk7XG4gICAgdGhpcy5jYWxsSG9vayhvYmosICduZ0FmdGVyVmlld0NoZWNrZWQnKTtcbiAgfVxuXG4gIHByaXZhdGUgY2FsbEhvb2sob2JqOiBhbnksIGhvb2s6IHN0cmluZywgYXJnczogYW55W10gPSBbXSkge1xuICAgIGlmIChvYmpbaG9va10pIHtcbiAgICAgIG9ialtob29rXSguLi5hcmdzKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==